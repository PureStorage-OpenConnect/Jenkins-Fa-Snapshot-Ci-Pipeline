# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

pool: 'Self Hosted Win2016'

steps:
  - task: MSBuild@1
    displayName: 'Build DACPAC'
    inputs:
      solution: 'Jenkins-Fa-Snapshot-Ci-Pipeline.sln'
  # Create a secret variable
  - powershell: |
      $securePassword = ConvertTo-SecureString -String '$(pfaPassword)' -AsPlainText -Force
      $pfaCreds = New-Object System.Management.Automation.PSCredential '$(pfaUsername)', $securePassword
      $Targets = @('Z-STN-WIN2016-A\DEVOPSDEV1')
      Invoke-PfaDbRefresh -RefreshDatabase $(refreshDatabase) `
                          -RefreshSource   $(refreshSource) `
                          -DestSqlInstance $Targets `
                          -PfaEndpoint     $(pfaEndpoint) `
                          -PfaCredentials  $pfaCreds

  - script: echo $(System.DefaultWorkingDirectory)
    displayName: 'Apply DACPAC'